<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/css.css">
</head>
<body id="body">

	<div id="mapContainer">
		<canvas id='gameMap' width='512' height='512'></canvas>
		<img id='canvasBg'>
	</div>

	<div class="dPad" oncontextmenu="return false;">
		<img id="upButton" class="arrowImage" src="./image/upButton.png">
		<img id="downButton" class="arrowImage" src="./image/downButton.png">
		<img id="leftButton" class="arrowImage" src="./image/leftButton.png">
		<img id="rightButton" class="arrowImage" src="./image/rightButton.png">
	</div>

	<script src="js/resources/pics.js"></script>

	<script src="js/app.js"></script>
	<script src="http://127.0.0.1/projects/GameJam/GameJam092015-Huanga/node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
	<script src="js/libs/observable.js"></script>
	<script src="js/models/playerModel.js"></script>
	<script src="js/models/tileModel.js"></script>
	<script src="js/models/mapModel.js"></script>
	<script src="js/controllers/globalController.js"></script>
	<script src="js/views/globalView.js"></script>
	<script src="js/models/globalModel.js"></script>
	<script>

	var main = app.startGlobal();


	var tiles = [
		{
			0:{name: 'tileStone32x.png',size:{width: 32, height: 32},isBlock: true},
		 	1:{name: 'tileStoneB32x.png',size:{width: 32, height: 32},isBlock: true},
		},
		{0:{name: 'tileSand32x.png',size:{width: 32, height: 32},isBlock: false}},
	];
	var others = [];

	main.map.setMapTilesList(tiles)



	  var socket = io('localhost:8080');
	  socket.on('connect', function () {
	    
	    socket.on('posIs', function (data){
			
			main.map.setMap(data.map).generateMap().updateModelMap(main.model);
			main.model.canvasBgArray = main.view.drawCanvas(main.model.activeMap);
			for (playerId in data.playersList){
				main.model.players[playerId] = new app.models.PlayerModel();
				main.model.players[playerId].setId(playerId).setTeam(data.playersList[playerId].teamId).setModel(main.model).setPos(data.playersList[playerId].pos);
				if (playerId === data.player.id){
					main.model.setPlayer(main.model.players[playerId]);
					main.model.player.drawCurrentArena(main.model.player);
					console.log(' : main player is : ' + playerId);
				}
			}
	    });

	    socket.on('start', function(){
	    	main.view.start();
	    });

	    socket.on('newPlayer', function (player){
	    	console.log('a new Player joined came to reinforce the team: ' + player.teamId);
				main.model.players[player.id] = new app.models.PlayerModel();
				main.model.players[player.id].setId(player.id).setTeam(player.teamId).setModel(main.model).setPos(player.pos);
	    });

	    socket.on('moved', function (data){
//console.log(data.player.id + ' moved to ', data.player.pos);
			if (main.model.players[data.player.id] !== main.model.player){
				if (main.model.player.isOnCurrentArena(main.model.players[data.player.id].pos)){
					main.model.players[data.player.id].deplacer(data.dir);
				}else{
		    		main.model.players[data.player.id].setPos(data.player.pos);
				}
		    }	
	    });

	    socket.on('disconnected', function (player){
	    	delete main.model.players[player.id];
	    });
	  });


		
	</script>
</body>
</html>
