<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/css.css">
</head>
<body id="body">

	<div id="mapContainer">
		<img id='canvasBg'>
	</div>
	<div id="gui">
		<div id="playerInfo">
			<img id="baseChara" src="./image/gui/baseChara.png" alt="">
			<img id="playerTeam" src="" alt="">
		</div>
		<div class="dPad">
			<img id="controller" src="./image/gui/controleurBackground.png" alt="">
			<img id="upButton" class="arrowImage" src="./image/gui/controlerTop.png">
			<img id="downButton" class="arrowImage" src="./image/gui/controlerBottom.png">
			<img id="leftButton" class="arrowImage" src="./image/gui/controlerLeft.png">
			<img id="rightButton" class="arrowImage" src="./image/gui/controlerRight.png">
		</div>
		<div id="check-reso">
		</div>
	</div>
	


	<script src="js/resources/pics.js"></script>

	
	<script src="js/libs/socket.io-client/socket.io.js"></script>
	<script src="js/app.js"></script>
	<script src="js/libs/observable.js"></script>
	<script src="js/models/teamModel.js"></script>
	<script src="js/models/playerModel.js"></script>
	<script src="js/models/tileModel.js"></script>
	<script src="js/models/mapModel.js"></script>
	<script src="js/models/formModel.js"></script>
	<script src="js/controllers/globalController.js"></script>
	<script src="js/views/globalView.js"></script>
	<script src="js/models/globalModel.js"></script>
	<script>
		var canvas = document.createElement('canvas');
		document.getElementById('mapContainer').appendChild(canvas);
		canvas.setAttribute('id', 'gameMap');

		var main = app.startGlobal('www.huanga.eleguen.ovh','8081');
		var globalModel = main.models.model;
		var resolution = globalModel.resolution;
		var socket = main.socket;

		canvas.setAttribute('width', (resolution*16));
		canvas.setAttribute('height', (resolution*16));

		var teams = [
			new Team(0).setImageSrc(Pics.paths.teams).setName('fire').setImage(Pics.teamsPics[0] + resolution + '.png').setModel(globalModel),
			new Team(1).setImageSrc(Pics.paths.teams).setName('water').setImage(Pics.teamsPics[1] + resolution + '.png').setModel(globalModel),
			new Team(2).setImageSrc(Pics.paths.teams).setName('earth').setImage(Pics.teamsPics[2] + resolution + '.png').setModel(globalModel),
			];
		var tiles = [
			{
				0:{path: Pics.paths.walls, name: 'tileStone_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true,type:'wall',factor: 1},
			 	1:{path: Pics.paths.walls, name: 'tileStoneB_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true,type:'wall',factor: 1},
			 	2:{path: Pics.paths.walls, name: 'tileStoneC_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true,type:'wall',factor: 1},
			 	3:{path: Pics.paths.walls, name: 'tileStoneD_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true,type:'wall',factor: 1},
			 	4:{path: Pics.paths.walls, name: 'tileStoneE_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true,type:'wall',factor: 1},
			},
			{
				0:{path: Pics.paths.grounds, name: 'tileSand_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: false,type:'ground',factor: 1},
				1:{path: Pics.paths.grounds, name: 'tileSandB_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: false,type:'ground',factor: 1},
			},
			{
				0:{path: Pics.paths.blocks, name: 'tileBlock_' + 3 * resolution + '.png',size:{width: 3 * resolution, height: 3 * resolution},isBlock: true,type:'block',factor: 3},
				1:{path: Pics.paths.blocks, name: 'tileBlockB_' + 3 * resolution + '.png',size:{width: 3 * resolution, height: 3 * resolution},isBlock: true,type:'block',factor: 3},
				2:{path: Pics.paths.blocks, name: 'tileBlockC_' + 3 * resolution + '.png',size:{width: 3 * resolution, height: 3 * resolution},isBlock: true,type:'block',factor: 3},
				3:{path: Pics.paths.blocks, name: 'tileBlockD_' + 3 * resolution + '.png',size:{width: 3 * resolution, height: 3 * resolution},isBlock: true,type:'block',factor: 3},
			},
		];

		var tilesWeight = [
			[0.3,0.45,0.05,0.15,0.05], //walls
			[9.7,0.3], // grounds
			[0.25,0.25,0.25,0.25], // blocks
		];

		var others = [];

		main.models.map.setMapTilesList(tiles)

		  main.socket.on('connect', function () {
		    
		    main.socket.on('posIs', function (data){	
				main.models.map.setMap(data.map).setTilesWeight(tilesWeight).generateMap().updateModelMap(globalModel);
				globalModel.canvasBgArray = main.views.view.drawCanvas(globalModel.activeMap);
				for (playerId in data.playersList){
					globalModel.players[playerId] = new app.models.PlayerModel();
					globalModel.players[playerId].setId(playerId).setTeam(data.playersList[playerId].teamId).setModel(globalModel).setPos(data.playersList[playerId].pos);
					if (playerId === data.player.id){
						console.log(globalModel.players[playerId])
						document.getElementById('playerTeam').setAttribute('src','./image/teams/Chara' 
							+ globalModel.players[playerId].team.name.charAt(0).toUpperCase() 
							+ globalModel.players[playerId].team.name.substring(1) 
							+ '.png');
							globalModel.setPlayer(globalModel.players[playerId]);
							setTimeout(function(){globalModel.player.drawCurrentArena()},1000);//globalModel.player.drawCurrentArena();
							console.log('Main player is : ' + playerId);
					}
				}
		    });

		    main.socket.on('start', function(){
		    	main.views.view.start();
		    });

		    main.socket.on('newPlayer', function (player){
		    	console.log('a new Player joined came to reinforce the team: ' + player.teamId);
					globalModel.players[player.id] = new app.models.PlayerModel();
					globalModel.players[player.id].setId(player.id).setTeam(player.teamId).setModel(globalModel).setPos(player.pos);
		    });

		    main.socket.on('moved', function (data){
	//	console.log(data.player.id + ' moved to ', data.player.pos);
				if (data.player.id !== globalModel.player.id){
					if (globalModel.player.isOnCurrentArena(globalModel.players[data.player.id].pos)){
						globalModel.players[data.player.id].isMoveCompleted(data.player.pos,data.dir);
					}else{
			    		globalModel.players[data.player.id].setPos(data.player.pos);
					}
			    }	
		    });

		    main.socket.on('contact', function (data){
	console.log('contact!!', data);
		    	if (globalModel.player.isOnCurrentArena(globalModel.players[data.contact.player1.id].pos)){
		    		globalModel.players[data.contact.player1.id].team.eat(globalModel.players[data.contact.player1.id],globalModel.players[data.contact.player2.id]);
		    	}
		    });

		    main.socket.on('disconnected', function (player){
		    	delete globalModel.players[player.id];
		    });
		});


		
	</script>
</body>
</html>
