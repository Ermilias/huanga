<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/css.css">
</head>
<body id="body">

	<div id="mapContainer">
		<img id='canvasBg'>
	</div>
	<div id="gui">
		<div id="playerInfo">
			<img id="playerTeam" src="" alt="">
		</div>
		<div class="dPad">
			<img id="controller" src="./image/gui/controleurBackground.png" alt="">
			<img id="upButton" class="arrowImage" src="./image/gui/controlerTop.png">
			<img id="downButton" class="arrowImage" src="./image/gui/controlerBottom.png">
			<img id="leftButton" class="arrowImage" src="./image/gui/controlerLeft.png">
			<img id="rightButton" class="arrowImage" src="./image/gui/controlerRight.png">
		</div>
	</div>
	
	<div id="check-reso">
	</div>


	<script src="js/resources/pics.js"></script>

	<script src="../node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
	<script src="js/app.js"></script>
	<script src="js/libs/observable.js"></script>
	<script src="js/models/teamModel.js"></script>
	<script src="js/models/playerModel.js"></script>
	<script src="js/models/tileModel.js"></script>
	<script src="js/models/mapModel.js"></script>
	<script src="js/models/formModel.js"></script>
	<script src="js/controllers/globalController.js"></script>
	<script src="js/views/globalView.js"></script>
	<script src="js/models/globalModel.js"></script>
	<script>
		var canvas = document.createElement('canvas');
		document.getElementById('mapContainer').appendChild(canvas);
		canvas.setAttribute('id', 'gameMap');

		var main = app.startGlobal('78.229.248.133','8080');
		var resolution = main.models.model.resolution;
		var socket = main.socket;

		canvas.setAttribute('width', (resolution*16));
		canvas.setAttribute('height', (resolution*16));

		var teams = [
			new Team(0).setImageSrc(Pics.paths.teams).setName('fire').setImage(Pics.teamsPics[0] + resolution + '.png').setModel(main.models.model),
			new Team(1).setImageSrc(Pics.paths.teams).setName('water').setImage(Pics.teamsPics[1] + resolution + '.png').setModel(main.models.model),
			new Team(2).setImageSrc(Pics.paths.teams).setName('earth').setImage(Pics.teamsPics[2] + resolution + '.png').setModel(main.models.model),
			];
		var tiles = [
			{
				0:{path: Pics.paths.walls, name: 'tileStone_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true},
			 	1:{path: Pics.paths.walls, name: 'tileStoneB_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: true},
			},
			{
				0:{path: Pics.paths.grounds, name: 'tileSand_' + resolution + '.png',size:{width: resolution, height: resolution},isBlock: false}
			},
		];
		var others = [];

		main.models.map.setMapTilesList(tiles)

		  main.socket.on('connect', function () {
		    
		    main.socket.on('posIs', function (data){
				
				main.models.map.setMap(data.map).generateMap().updateModelMap(main.models.model);
				main.models.model.canvasBgArray = main.views.view.drawCanvas(main.models.model.activeMap);
				for (playerId in data.playersList){
					main.models.model.players[playerId] = new app.models.PlayerModel();
					main.models.model.players[playerId].setId(playerId).setTeam(data.playersList[playerId].teamId).setModel(main.models.model).setPos(data.playersList[playerId].pos);
					if (playerId === data.player.id){
						console.log(main.models.model.players[playerId])
					document.getElementById('playerTeam').setAttribute('src','./image/teams/Chara' 
						+ main.models.model.players[playerId].team.name.charAt(0).toUpperCase() 
						+ main.models.model.players[playerId].team.name.substring(1) 
						+ '.png');
						main.models.model.setPlayer(main.models.model.players[playerId]);
						main.models.model.player.drawCurrentArena(main.models.model.player);
						console.log('Main player is : ' + playerId);
					}
				}
		    });

		    main.socket.on('start', function(){
		    	main.views.view.start();
		    });

		    main.socket.on('newPlayer', function (player){
		    	console.log('a new Player joined came to reinforce the team: ' + player.teamId);
					main.models.model.players[player.id] = new app.models.PlayerModel();
					main.models.model.players[player.id].setId(player.id).setTeam(player.teamId).setModel(main.models.model).setPos(player.pos);
		    });

		    main.socket.on('moved', function (data){
	//	console.log(data.player.id + ' moved to ', data.player.pos);
				if (main.models.model.players[data.player.id] !== main.models.model.player){
					if (main.models.model.player.isOnCurrentArena(main.models.model.players[data.player.id].pos)){
						main.models.model.players[data.player.id].isMoveCompleted(data.player.pos,data.dir);
					}else{
			    		main.models.model.players[data.player.id].setPos(data.player.pos);
					}
			    }	
		    });

		    main.socket.on('contact', function (data){
	//	console.log('contact!!', data);
		    	if (main.models.model.player.isOnCurrentArena(main.models.model.players[data.contact.player1.id].pos)){
		    		main.models.model.players[data.contact.player1.id].team.eat(main.models.model.players[data.contact.player1.id],main.models.model.players[data.contact.player2.id]);
		    		//main.models.model.players[data.contact.player2.id].team.eat(main.models.model.players[data.contact.player2.id],main.models.model.players[data.contact.player1.id]);
		    	}
		    });

		    main.socket.on('disconnected', function (player){
		    	delete main.models.model.players[player.id];
		    });
		});


		
	</script>
</body>
</html>
